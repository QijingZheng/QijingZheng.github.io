<!DOCTYPE html>



<html lang="en-US" 
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  
    <meta name="pv-cache-enabled" content="false">

    
  

  <!-- for mathjax support -->
  
    
      <!-- MathJax 3 -->
<script>
  MathJax = {
    tex: {
      inlineMath:     [['$', '$'], ['\\(', '\\)']],
      displayMath:    [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      tags:           'ams'
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<!-- <script type="text/javascript" id="MathJax&#45;script" async -->
<!--   src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex&#45;mml&#45;chtml.js"> -->
<!-- </script> -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.1/es5/tex-mml-chtml.min.js"
  integrity="sha512-lt3EkmQb16BgAXR0iCk+JUJyDFmS9NZEMXCXK169qQoWcXu9CS4feejtxkjjUruw/Y0XfL1qxh41xVQPvCxM1A=="
  crossorigin="anonymous" referrerpolicy="no-referrer">
</script>
<!-- <script type="text/javascript" id="MathJax&#45;script" async -->
<!--         src='/assets/mathjax3/es5/tex&#45;mml&%2345;chtml.js'> -->
<!-- </script> -->

<!-- <script type="text/javascript" id="MathJax&#45;script" async -->
<!--   src='/assets/js/lib/tex&#45;mml&%2345;chtml.js'> -->
<!-- </script> -->

    
  

  <!-- for video.js support -->
  

  <!-- for plotly support -->
  

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Molecular Dynamics at Constant Temperature" />
<meta name="author" content="Qijing Zheng" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Canonical Ensemble" />
<meta property="og:description" content="Canonical Ensemble" />
<link rel="canonical" href="https://qijingzheng.github.io/posts/NVT-MD/" />
<meta property="og:url" content="https://qijingzheng.github.io/posts/NVT-MD/" />
<meta property="og:site_name" content="Qijing Zheng" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-20T22:10:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Molecular Dynamics at Constant Temperature" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"https://qijingzheng.github.io/posts/NVT-MD/","headline":"Molecular Dynamics at Constant Temperature","dateModified":"2021-05-20T22:10:00+08:00","datePublished":"2021-05-20T22:10:00+08:00","author":{"@type":"Person","name":"Qijing Zheng"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://qijingzheng.github.io/posts/NVT-MD/"},"description":"Canonical Ensemble","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <title>Molecular Dynamics at Constant Temperature | Qijing Zheng
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://www.favicon-generator.org/
-->



<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon">
<link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon">

<link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png">
<link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png">
<link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png">

<link rel="icon" type="image/png" sizes="192x192"  href="/assets/img/favicons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

<link rel="manifest" href="/assets/img/favicons/manifest.json">
<meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'>
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">


  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- GA -->
  

  <!-- jsDelivr CDN -->
  <link rel="preconnect" href="cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="cdn.jsdelivr.net">

  <!-- Bootstrap -->
  <!-- <link rel="stylesheet" -->
  <!--   href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" -->
  <!--   integrity="sha256&#45;LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"> -->
  <link rel="stylesheet" href='/assets/css/bootstrap.min.css'>

  <!-- Font Awesome -->
  <!-- <link rel="stylesheet" -->
  <!--   href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome&#45;free@5.11.2/css/all.min.css" -->
  <!--   integrity="sha256&#45;+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" -->
  <!--   crossorigin="anonymous"> -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
        integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!--
  CSS selector for site.
-->

<link rel="stylesheet" href="/assets/css/style.css">


  <link rel="stylesheet"
    href='/assets/css/bootstrap-toc.css'>



  <!-- for video.js support -->
  

  <!-- JavaScripts -->

  <script src='/assets/js/dist/jquery.min.js'></script>

  <script defer
    src='/assets/js/dist/bootstrap.min.js'></script>

  <!--
  JS selector for site.
-->


  





<script defer src="/assets/js/dist/post.min.js"></script>






  
      <link rel="stylesheet"
  href="/assets/lightbox2/css/lightbox2.css" />
<link rel="stylesheet"
  href="/assets/splide/css/splide-skyblue.min.css" />

<script src="/assets/lightbox2/js/lightbox-plus-jquery.min.js" ></script>
<script type="text/javascript">
    lightbox.option({
        'alwaysShowNavOnTouchDevices' : true,
        'resizeDuration': 200,
        'wrapAround': true
    })
</script>

<script src="/assets/splide/js/splide.min.js"></script>
<script type="text/javascript">
    document.addEventListener( 'DOMContentLoaded', function () {
        new Splide( '#image-slider',
            {
                type: 'loop',
                perPage: 1,
                rewind:    false,
                gap: 2,
                autoplay: true,
            }
        ).mount();
    } );
</script>

  



</head>


  <body data-spy="scroll" data-target="#toc">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">

  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
        <img src="/assets/img/me/profile_redeye.gif" alt="avatar" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">Qijing Zheng</a>
    </div>

    <div class="site-subtitle font-italic"><div style="height: 6px"> </div>
Associate Professor <br />
<div style="height: 6px"> </div>
Department of Physics <br />
<div style="height: 6px"> </div>
University of Science &amp; Technology of China 
<div style="height: 12px"> </div></div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">
    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/members/" class="nav-link">
        <i class="fa-fw fas fa-user ml-xl-3 mr-xl-3 unloaded"></i>
        <span>MEMBERS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/publication/" class="nav-link">
        <i class="fa-fw fas fa-newspaper ml-xl-3 mr-xl-3 unloaded"></i>
        <span>PUBLICATIONS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/post/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        <span>POSTS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/link/" class="nav-link">
        <i class="fa-fw fas fa-link ml-xl-3 mr-xl-3 unloaded"></i>
        <span>LINKS</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div style="padding-left: 0px" class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center">

    
      <span id="mode-toggle-wrapper" class="ml-auto order-0">
        <!--
  Switch the mode between dark and light.
-->

<i class="mode-toggle fas fa-adjust"></i>

<script type="text/javascript">

  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      var self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addListener(function() {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.updateMermaid();
      });

    } /* constructor() */


    setDark() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_KEY);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer) ) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    updateMermaid() {
      if (typeof mermaid !== "undefined") {
        let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default");
        let config = { theme: expectedTheme };

        /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */
        $(".mermaid").each(function() {
          let svgCode = $(this).prev().children().html();
          $(this).removeAttr("data-processed");
          $(this).html(svgCode);
        });

        mermaid.initialize(config);
        mermaid.init(undefined, ".mermaid");
      }
    }

    flipMode() {
      if (this.hasMode) {
        if (this.isSysDarkPrefer) {
          if (this.isLightMode) {
            this.clearMode();
          } else {
            this.setLight();
          }

        } else {
          if (this.isDarkMode) {
            this.clearMode();
          } else {
            this.setDark();
          }
        }

      } else {
        if (this.isSysDarkPrefer) {
          this.setLight();
        } else {
          this.setDark();
        }
      }

      this.updateMermaid();

    } /* flipMode() */

  } /* ModeToggle */

  let toggle = new ModeToggle();

  $(".mode-toggle").click(function() {

    toggle.flipMode();

  });

</script>

      </span>

      
        <span class="icon-border order-1"></span>
      

    

    
      

      
      <a href="https://github.com/QijingZheng" aria-label="github"
        
          class="order-3"
          target="_blank" rel="noopener">
        
        <i class="fab fa-github-alt"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['zqj','ustc.edu.cn'].join('@')" aria-label="email"
        
          class="mr-auto order-4"
          >
        
        <i class="fas fa-envelope"></i>
      </a>
      

    

    

  </div> <!-- .sidebar-bottom -->


</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          

        

      

        
        <span>
          
          
          <a href="/">
            Posts
          </a>
        </span>

        

      

        
          <span>Molecular Dynamics at Constant Temperature</span>

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->


<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->


<!-- Add attribute 'hide-bullet' to the checkbox list -->




  

  

  <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->
  
  

  

  



<!-- return -->
<div class="row">

  <div id="post-wrapper" class="col-12 col-lg-11 col-xl-8">

    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

      <h1 data-toc-skip>Molecular Dynamics at Constant Temperature</h1>

      <div class="post-meta text-muted d-flex flex-column">
        <!-- Published date and author -->
        <div>
          <!--
  Date format snippet
-->





<span class="timeago "
  
    data-toggle="tooltip"
    data-placement="bottom"
    title="Thu, May 20, 2021, 10:10 PM +0800"
  >

  
  

  
    May 20, 2021
  

  <i class="unloaded">2021-05-20T22:10:00+08:00</i>

</span>

          by
          <span class="author">
            Qijing Zheng
          </span>
        </div>

        <div>
          <!-- lastmod -->
          

          <!-- read time -->
          <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->


<!-- words per minute  -->







<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4623 words">25 min</span>


          <!-- page views -->
          

        </div>

      </div> <!-- .post-meta -->

      <div class="post-content">

        

        <h2 id="canonical-ensemble">Canonical Ensemble</h2>

<p>In a canonical ensemble, the particle number $N$, the volume $V$ and the
temperature $T$ are fixed. The temperature of the system is connected to the
averaged kinetic energy via</p>

\[\begin{equation}
\frac{3}{2} N k_B T = \langle E_{\mathrm{kin}} \rangle
\end{equation}\]

<p>Although the temperature and the average kinetic energy are fixed, the
instantaneous kinetic energy fluctuates and with it the velocities of the
particles. The instantaneous kinetic energy is often used to define the
instantaneous temperature $T_\mathrm{in}$ by</p>

\[\begin{equation}
k_B T_{\mathrm{in}} = {2\over 3N} E_{\mathrm{kin}}
\end{equation}\]

<p>Note that in the microcanonical ensemble ($NVE$), the termperature is defined as
$1 / T = \partial S /\partial E$. There is <strong>NO connection</strong> between the average
kinetic energy and temperature.</p>

<p>In equilibrium, the relative variance of the instantaneous termperature
fluctuation in a canonical ensemble is<sup id="fnref:FrenkelSmit" role="doc-noteref"><a href="#fn:FrenkelSmit" class="footnote">1</a></sup></p>

\[\begin{equation}
\label{eq:temperature_var}
\frac{
    \langle \Delta T^2 \rangle
}{T^2}
=
\frac{
    \langle (T_k - T)^2 \rangle 
}{
    T^2
} =
{2 \over 3N}
\end{equation}\]

<p>where $T = \langle T_k \rangle$ and $N$ is the number of atoms. In the
thermodynamic limit ($N \to \infty$ and $V \to \infty$ while $N/V =
\mathtt{const}$), the fluctuation is negligible.  The fluctuation to become
negligible in the thermodynamic limit is a general result, thus we are always at
liberty to choose the ensemble that is most convenient for a particular problem
and still obtain the same macroscopic observables. It must be stressed, however,
this freedom <em>only</em> exists in thermodynamic limit.  Note, Eq.
\eqref{eq:temperature_var} can be used to check whether the simulation has
reached equilibrium.</p>

<p>There are essentially <strong>three</strong> classes of method to control temperature in an MD
simulation:<sup id="fnref:CameronAbrams" role="doc-noteref"><a href="#fn:CameronAbrams" class="footnote">2</a></sup></p>

<ul>
  <li>
    <p>Velocity scaling method (e.g. velocity rescaling and Berendsen thermostat)</p>
  </li>
  <li>
    <p>Stochastic thermostat (e.g., Andersen thermostat, Langevin thermostat)</p>
  </li>
  <li>
    <p>“Extended Lagrangian” formalisms (e.g., Nosé-Hoover thermostat, Nosé-Hoover Chain)</p>
  </li>
</ul>

<h2 id="velocity-rescaling">Velocity Rescaling</h2>

<h2 id="stochastic-thermostat">Stochastic Thermostat</h2>

<h3 id="andersen-thermostat">Andersen Thermostat</h3>

<p>A few remarks on the collision frequency:</p>

<ul>
  <li>
    <p>An <strong>arbitrarily non-zero collision frequency</strong> are sufficient to guarantee in
principle the generation of a canonical ensemble.</p>
  </li>
  <li>
    <p>Too small values (loose coupling) may cause a poor temperature control. The
canonical distribution will only be obtained after very long simulation times.
In this case, systematic energy drifts due to accumulation of numerical errors
may interfere with the thermostatization.</p>
  </li>
  <li>
    <p>Too large values for the collision frequency (tight coupling) may cause the
velocity reassignments to perturb heavily the dynamics of the system.</p>
  </li>
</ul>

<p>Pros and Cons</p>

<h3 id="langevin-thermostat">Langevin Thermostat</h3>

<p>The equation of motion for Langevin dynamics is</p>

\[\begin{equation}
\label{eq:langevin_eom}
m\frac{\mathrm{d}^2 \mathbf{r}_i}{\mathrm{d} t^2} = -\nabla V(\mathbf{r}_1,\ldots,\mathbf{r}_N) - \gamma m \mathbf{v}_i + \mathbf{R}_i
\end{equation}\]

<h4 id="velocity-verlet-algorithm-for-langevin-thermostats">Velocity-Verlet algorithm for Langevin thermostats</h4>

\[\begin{align}
\mathbf{v}_i(t + {\delta t\over 2}) &amp;= \mathbf{v}_i(t) + {\delta t \over 2m} \left[
                                           \mathbf{F}_i - \gamma m \mathbf{v}_i
                                       \right] + \mathbf{R}_i
\end{align}\]

<details>
  <summary>CLICK TO SHOW THE CODE!</summary>
  <div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python
# -*- coding: utf-8 -*-
</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>


<span class="k">def</span> <span class="nf">harmonic_pot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s">'''
    The harmonic potential
    '''</span>

    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">harmonic_for</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s">'''
    The force of harmonic potential
    '''</span>

    <span class="k">return</span> <span class="o">-</span> <span class="n">m</span> <span class="o">*</span> <span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">Ekin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s">'''
    The force of harmonic potential
    '''</span>

    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s">'''
    '''</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"{:20.8E} {:20.8E} {:20.8E} {:20.8E} {:20.8E}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span>
        <span class="n">Ekin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> 
        <span class="n">harmonic_pot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">),</span>
        <span class="n">harmonic_pot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ekin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="p">))</span>


<span class="k">def</span> <span class="nf">vv</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">f0</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="s">'''
    Velocity Verlet integration
    '''</span>

    <span class="k">if</span> <span class="n">f0</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">harmonic_for</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>

    <span class="n">log</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span><span class="p">):</span>
        <span class="c1"># x(t+dt) = x(t) + v(t) * dt + f(t) * dt**2 / (2*m)
</span>        <span class="n">x1</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">v0</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">f0</span> <span class="o">*</span> <span class="n">dt</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
        <span class="c1"># f(t+dt)
</span>        <span class="n">f1</span> <span class="o">=</span> <span class="n">harmonic_for</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
        <span class="c1"># v(t+dt) = v(t) + dt * (f(t) + f(t+dt)) / (2*m)
</span>        <span class="n">v1</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">f1</span> <span class="o">+</span> <span class="n">f0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>

        <span class="n">log</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">f0</span> <span class="o">=</span> <span class="n">x1</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">f1</span>

<span class="k">def</span> <span class="nf">langevin</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">f0</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="s">'''
    Velocity Verlet integration for Nose-Hoover thermostat
    '''</span>

    <span class="k">if</span> <span class="n">f0</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">harmonic_for</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>

    <span class="n">log</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>

    <span class="c1"># the random force is sampled from Gaussian distribution with variance
</span>    <span class="c1"># sigma**2
</span>    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">T</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">R0</span>    <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">standard_normal</span><span class="p">()</span> <span class="o">*</span> <span class="n">sigma</span>

    <span class="c1"># 0, 1, 2 represents t, t + 0.5*dt, and t + dt, respectively
</span>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span><span class="p">):</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">f0</span> <span class="o">-</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">v0</span> <span class="o">+</span> <span class="n">R0</span><span class="p">)</span> <span class="o">/</span> <span class="n">m</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">harmonic_for</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
        <span class="n">R2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">standard_normal</span><span class="p">()</span> <span class="o">*</span> <span class="n">sigma</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">f2</span> <span class="o">-</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">R2</span><span class="p">)</span> <span class="o">/</span> <span class="n">m</span>

        <span class="n">log</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="n">R0</span> <span class="o">=</span> <span class="n">x2</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">R2</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">T0</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">T0</span><span class="p">)</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">N</span>  <span class="o">=</span> <span class="mi">10000</span>

    <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">20210605</span><span class="p">)</span>

    <span class="n">langevin</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">0</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
    <span class="n">langevin</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
    <span class="n">langevin</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div>  </div>
</details>

<div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="n">T0</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">T0</span><span class="p">)</span>
<span class="n">N</span>  <span class="o">=</span> <span class="mi">10000</span>

<span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">20210605</span><span class="p">)</span>
<span class="n">langevin</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<figure>
    <div align="center">
        <a href="/assets/img/post/nvt_md/langevin/langevin.png" data-lightbox="roadtrip">
          <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/nvt_md/langevin/langevin.png" width="75%" />
        </a>
    </div>
  
    <figcaption style="text-align: center; padding: 10px">
      <b> Figure 1. </b>
      Phase space distribution of 1D harmonic oscillator obtained from MD
      simulation with the Langevin thermostat. The friction term was chosen to match
      the frequency of the harmonic oscillator. The parameters for the simulation
      are $T = 0.1; dt = 0.1, N = 10000; x_0 = 0; v_0 = \sqrt{2T}; \gamma = {1\over 2\pi}$.
      Figure plotted using
      <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/langevin/plt_langevin_xp.py">this script</a>
      with 
      <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/langevin/langevin_nvt.dat">this input data.</a>
    </figcaption>
  </figure>

<figure>
    <div align="center">
        <a href="/assets/img/post/nvt_md/langevin/gamma_langevin.png" data-lightbox="roadtrip">
            <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/nvt_md/langevin/gamma_langevin.png" width="95%" />
        </a>
    </div>
  
    <figcaption style="text-align: center; padding: 10px">
      <b> Figure 2. </b>
      Potential energy and kinetic energy from Langevin dynamics with different friction coefficients.
      Figure plotted using
      <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/langevin/plt_gamma_langevin.py">this script</a>
      with 
      <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/langevin/nvt_langevin_gamma.dat">this input data.</a>
    </figcaption>
  </figure>

<h2 id="extended-lagrangian-method">Extended Lagrangian Method</h2>

<h3 id="nosé-hoover-thermostat">Nosé-Hoover Thermostat</h3>

<p>In Nosé-Hoover’s approach<sup id="fnref:Nose_JCP" role="doc-noteref"><a href="#fn:Nose_JCP" class="footnote">3</a></sup><sup id="fnref:Hoover_PRA" role="doc-noteref"><a href="#fn:Hoover_PRA" class="footnote">4</a></sup>, an additional “agent” is
introduced into the system to “check” whether the instantaneous kinetic energy
is higher or lower than the desired temperature and then scales the velocities
accordingly, effectively acting as a heat reservoir.  Denoting this extra
variable as $s$ and its conjugate momentum as $p_s$, the Nosé Hamiltonian for
the extended system takes the form<sup id="fnref:Tuckerman" role="doc-noteref"><a href="#fn:Tuckerman" class="footnote">5</a></sup></p>

\[\begin{equation}
\label{eq:nose_hamil}
{\cal H}_N = \sum_{i=1}^{N} \frac{\mathbf{p}_i^2}{2m_i s^2} + V(\mathbf{r}_1,\ldots,\mathbf{r}_N) + 
             \frac{p_s^2}{2Q} + gk_BT\ln{s}
\end{equation}\]

<p>where $Q$ is “thermal inertia”, which determines the time scale on which the
extended variable acts. Note that $Q$ is <em>NOT</em> a mass! Rather, it has unit of
$[\mathtt{Energy} \times \mathtt{Time}^2]$, or equivalently $[\mathtt{Mass}
\times \mathtt{Length}^2]$. The logarithmic term is the potential for the extra
variable $s$.</p>

<p>On the other hand, the Hamiltonian of the <em>real system</em> is defined as</p>

\[\begin{equation}
\label{eq:real_hamil}
{\cal H}(\mathbf{p}', \mathbf{r}') = \sum_{i=1}^N \frac{\mathbf{p'}^2}{2m_i} + V(\mathbf{r}'_1,\ldots,\mathbf{r}'_N)
\end{equation}\]

<p>where the prime is used to indicate the <em>real variables</em>. Frow now on, we shall
refer to the primed variables as <em>real variables</em> and those in the Nosé system
as <em>virtual variables</em>. The real and virtual variables are related through<sup id="fnref:FrenkelSmit:1" role="doc-noteref"><a href="#fn:FrenkelSmit" class="footnote">1</a></sup><sup id="fnref:Nose_JCP:1" role="doc-noteref"><a href="#fn:Nose_JCP" class="footnote">3</a></sup></p>

\[\begin{align}
 \mathbf{r}' &amp;= \mathbf{r}      \\[6pt]
 \mathbf{p}' &amp;= \mathbf{p} / s  \\[6pt]
          s' &amp;= s               \\[6pt]
        p_s' &amp;= p_s / s         \\[6pt]
\mathrm{d}t' &amp;= \mathrm{d}t / s \label{eq:r2v_dt} \\[6pt]
\end{align}\]

<p>From Eq.\eqref{eq:r2v_dt}, it follows that $s$ can be interpreted as a scaling
factor of the time step.  In addition, the real and virtual times $\tau’$ and
$\tau$ are related by</p>

\[\begin{equation}
\label{eq:r2v_time_int}
\tau' = \int_0^{\tau} {1 \over s(t)}\, \mathrm{d}t 
\end{equation}\]

<p>The partition function of the extended system<sup id="fnref:FrenkelSmit:2" role="doc-noteref"><a href="#fn:FrenkelSmit" class="footnote">1</a></sup><sup id="fnref:Nose_JCP:2" role="doc-noteref"><a href="#fn:Nose_JCP" class="footnote">3</a></sup></p>

\[\begin{align}
Z_N &amp;= {1 \over N!} \int \mathrm{d} p_s \, \mathrm{d} s \,
                         \mathrm{d} \mathbf{p}^N \, \mathrm{d} \mathbf{r}^N \, 
                         \,\delta ({\cal H}_N - E) \nonumber \\[6pt]
    &amp;= {1 \over N!} \int \mathrm{d} p_s \, \mathrm{d} s \,
                         \mathrm{d} \mathbf{p'}^N \, \mathrm{d} \mathbf{r}^N \nonumber \\[6pt]
    &amp;\phantom{={}} s^{3N} \times \delta \left[
             \sum_{i=1}^{N} \frac{\mathbf{p'}_i^2}{2m_i} + V(\mathbf{r}_1,\ldots,\mathbf{r}_N) + 
             \frac{p_s^2}{2Q} + gk_BT\ln{s} - E
    \right]
\label{eq:nose_part_func}
\end{align}\]

<p>For a $\delta$-function of a function $h(s)$, we have this relation</p>

\[\begin{equation}
\label{eq:delta_function_relation}
\delta[h(s)] = \frac{\delta(s - s_0)}{|h'(s_0)|}
\end{equation}\]

<p>where $h(s)$ is a function that has single root at $s_0$. Substitute Eq.
\eqref{eq:delta_function_relation} into Eq.  \eqref{eq:nose_part_func}, we get
the following equation</p>

\[\begin{align}
Z_N &amp;= {1 \over N!} \int \mathrm{d} p_s \, \mathrm{d} s \,
                         \mathrm{d} \mathbf{p'}^N \, \mathrm{d} \mathbf{r}^N \nonumber \\[6pt]
    &amp;\phantom{={}} {\beta s^{3N+1} \over g} \times \delta \left\{
         s - \exp\left[ 
         -\beta { {\cal H}(\mathbf{p}', \mathbf{r}) + p_s^2 / (2Q) - E \over g}
         \right]
    \right\} \nonumber \\[6pt]
    &amp;= {1 \over N!} {\beta \exp[(3N+1)E/g] \over g} \int \mathrm{d} p_s \exp
    \left[
        -\beta{3N+1 \over g} {p_s^2 \over 2Q}
    \right] \nonumber \\[6pt]
    &amp;\phantom{={}} \times \int \mathrm{d} \mathbf{p'}^N \, \mathrm{d} \mathbf{r}^N \exp \left[
        -\beta {3N+1 \over g} {\cal H}(\mathbf{p}', \mathbf{r})
    \right] \nonumber \\[6pt]
    &amp;= C {1 \over N!} \int \mathrm{d} \mathbf{p'}^N \, \mathrm{d} \mathbf{r}^N \exp \left[
        -\beta {3N+1 \over g} {\cal H}(\mathbf{p}', \mathbf{r})
    \right]
    \label{eq:nose_part_func_final}
\end{align}\]

<p>For a physical quantity $\cal A$ that depends on $\mathbf{p}’$ and $\mathbf{r}$,
the microcanonical ensemble average of ${\cal A}$ in the extended system is
given by</p>

\[\begin{align}
\langle {\cal A}(\mathbf{p}/s, \mathbf{r}) \rangle_{\mathrm{Nosé}} &amp;= 
\frac{
    \displaystyle
    \int \mathrm{d} \mathbf{p'}^N \, \mathrm{d} \mathbf{r}^N \,
    {\cal A}(\mathbf{p}', \mathbf{r})
    \exp \left[
        -\beta {3N+1 \over g} {\cal H}(\mathbf{p}', \mathbf{r})
    \right]
}{
    \displaystyle
    \int \mathrm{d} \mathbf{p'}^N \, \mathrm{d} \mathbf{r}^N \,
    \exp \left[
        -\beta {3N+1 \over g} {\cal H}(\mathbf{p}', \mathbf{r})
    \right]
} \nonumber \\[6pt]
&amp;= 
\frac{
    \displaystyle
    {1 \over N!}
    \int \mathrm{d} \mathbf{p'}^N \, \mathrm{d} \mathbf{r}^N \,
    {\cal A}(\mathbf{p}', \mathbf{r})
    \exp \left[
        -\beta {\cal H}(\mathbf{p}', \mathbf{r})
    \right]
}{
    \displaystyle
    {1 \over N!}
    \int \mathrm{d} \mathbf{p'}^N \, \mathrm{d} \mathbf{r}^N \,
    \exp \left[
        -\beta {\cal H}(\mathbf{p}', \mathbf{r})
    \right]
} \nonumber \\[6pt]
&amp; = 
\langle {\cal A}(\mathbf{p}', \mathbf{r}) \rangle_{\mathrm{NVT}}
\label{eq:nose_ensemble_average}
\end{align}\]

<p>where in the second line, we have chosen $g = 3N + 1$.</p>

<p>Eq. \eqref{eq:nose_ensemble_average} indicates that the <em>canonical ensemble</em>
average of a centain physical quantity ${\cal A}(\mathbf{p}’, \mathbf{r})$ in a
<em>real system</em> with Hamiltonian ${\cal H}(\mathbf{p}’, \mathbf{r})$, which we
denote as $\langle {\cal A}(\mathbf{p}’, \mathbf{r}) \rangle_{\mathrm{NVT}}$, is
equivalent to the <em>microcanonical ensemble</em> average of ${\cal A}(\mathbf{p}/s,
\mathbf{r})$ in the extended Nosé system.</p>

<p>At this point, one can clearly see that the <em>logarithmic form of the
potential</em> ($gk_BT \ln s$) is <em>essential</em> in the derivation of Eq.
\eqref{eq:nose_part_func_final} and \eqref{eq:nose_ensemble_average}.</p>

<h4 id="eom-in-virtual-variables">EOM in virtual variables</h4>

<p>With the quasi-ergodic hypothesis, i.e. <em>time average equals ensemble average</em>,
we have</p>

\[\begin{equation}
\label{eq:ergodic_hypo}
\langle {\cal A}(\mathbf{p}', \mathbf{r}) \rangle_{\mathrm{NVT}}
= 
\langle {\cal A}(\mathbf{p}/s, \mathbf{r}) \rangle_{\mathrm{Nosé}}
=
\lim_{\tau \to \infty} {1\over\tau} \int_0^\tau {\cal A}\left(\mathbf{p}(t)/s(t), \mathbf{r}(t)\right)\, \mathrm{d}t
\end{equation}\]

<p>We can thus proceed by generating a trajectory following the equations of motion
(EOM) of the extended system, and get the canonical ensemble average of $\cal A$
in the real system by averaging over the trajectory according to
Eq.\eqref{eq:ergodic_hypo}.  From the Nosé Hamiltonian
(Eq.\eqref{eq:nose_hamil}), the EOM in virtual variables are given by</p>

\[\begin{align}
\frac{\mathrm{d} \mathbf{r}_i}{\mathrm{d} t} &amp;= {\partial\, {\cal H}_N \over
\partial\, \mathbf{p}_i} = \frac{\mathbf{p}_i}{m_i s^2} \label{eq:virtual_eom_1}\\[6pt]
\frac{\mathrm{d} \mathbf{p}_i}{\mathrm{d} t} &amp;= -{\partial\, {\cal H}_N \over
\partial\, \mathbf{r}_i} = -\frac{\partial\, V(\mathbf{r}_1,\ldots,\mathbf{r}_N)}{\partial\,\mathbf{r}_i} \label{eq:virtual_eom_2}\\[6pt]
\frac{\mathrm{d} s}{\mathrm{d} t} &amp;= {\partial\, {\cal H}_N \over \partial\, p_s} =
{p_s \over Q} \label{eq:virtual_eom_3}\\[6pt]
\frac{\mathrm{d} p_s}{\mathrm{d} t} &amp;= -{\partial\, {\cal H}_N \over \partial\, s} =
{1\over s}\left[\sum_i {\mathbf{p}_i^2\over m_i s^2} - gk_B T\right]\label{eq:virtual_eom_4}
\end{align}\]

<p>Note that $g = 3N + 1$ in Eq.\eqref{eq:virtual_eom_4}.</p>

<h4 id="eom-in-real-variables">EOM in real variables</h4>

<p>The last equivalence of Eq.\eqref{eq:ergodic_hypo} is done by sampling data
points at integer multiples of <em>virtual time step</em> $\mathrm{d}t$. According to
Eq.\eqref{eq:r2v_dt}, this means that the <em>real time step</em> $\mathrm{d}t’$ is
fluctuating.  Using Eq.\eqref{eq:r2v_time_int}, the time average of $\cal A$ in
the real time $t’$ can be written</p>

\[\begin{align}
&amp;\lim_{\tau' \to \infty} {1\over\tau'} \int_0^{\tau'} {\cal A}\left(\mathbf{p}(t')/s(t'), \mathbf{r}(t')\right)\, \mathrm{d}t' \nonumber\\[6pt]
&amp;= 
\lim_{\tau' \to \infty} {\tau \over \tau'} {1\over\tau} \int_0^\tau { {\cal A}\left(\mathbf{p}(t)/s(t), \mathbf{r}(t)\right) / s(t)}\, \mathrm{d}t \nonumber \\[6pt]
&amp;= \frac{
    \displaystyle
    \lim_{\tau \to \infty} {1\over\tau} \int_0^\tau { {\cal A}\left(\mathbf{p}(t)/s(t), \mathbf{r}(t)\right) / s(t)}\, \mathrm{d}t \nonumber 
}{
    \displaystyle
    \lim_{\tau \to \infty} {1\over\tau} \int_0^\tau {1\over s(t)}\, \mathrm{d}t \nonumber 
} \\[6pt]
&amp;= \frac{
    \displaystyle
    \langle { {\cal A}(\mathbf{p}/s, \mathbf{r}) / s } \rangle_{\mathrm{Nosé}}
}{
    \langle { 1 / s } \rangle_{\mathrm{Nosé}}
} \label{eq:real_time_aver}
\end{align}\]

<p>Consider again the Nosé partition function Eq.\eqref{eq:nose_part_func},
Eq.\eqref{eq:real_time_aver} becomes</p>

\[\begin{align}
\frac{
    \langle { {\cal A}(\mathbf{p}/s, \mathbf{r}) / s } \rangle_{\mathrm{Nosé}}
}{
    \langle { 1 / s } \rangle_{\mathrm{Nosé}}
} &amp;=
\frac{
    \left\{
    {
    \displaystyle
        \int \mathrm{d} \mathbf{p'}^N \, \mathrm{d} \mathbf{r}^N
        {\cal A}(\mathbf{p}', \mathbf{r})
        \exp \left[
            -\beta {3N \over g} {\cal H}(\mathbf{p}', \mathbf{r})
        \right]
    }
    \over
    {
    \displaystyle
        \int \mathrm{d} \mathbf{p'}^N \, \mathrm{d} \mathbf{r}^N
        \exp \left[
            -\beta {3N + 1 \over g} {\cal H}(\mathbf{p}', \mathbf{r})
        \right]
    }
    \right\}
}{
    \left\{
    {
    \displaystyle
        \int \mathrm{d} \mathbf{p'}^N \, \mathrm{d} \mathbf{r}^N
        \exp \left[
            -\beta {3N \over g} {\cal H}(\mathbf{p}', \mathbf{r})
        \right]
    }
    \over
    {
    \displaystyle
        \int \mathrm{d} \mathbf{p'}^N \, \mathrm{d} \mathbf{r}^N
        \exp \left[
            -\beta {3N + 1 \over g} {\cal H}(\mathbf{p}', \mathbf{r})
        \right]
    }
    \right\}
} \nonumber \\[12pt]

&amp;= \frac{
    \displaystyle
        \int \mathrm{d} \mathbf{p'}^N \, \mathrm{d} \mathbf{r}^N
        {\cal A}(\mathbf{p}', \mathbf{r})
        \exp \left[
            -\beta {3N \over g} {\cal H}(\mathbf{p}', \mathbf{r})
        \right]
}{
    \displaystyle
        \int \mathrm{d} \mathbf{p'}^N \, \mathrm{d} \mathbf{r}^N
        \exp \left[
            -\beta {3N \over g} {\cal H}(\mathbf{p}', \mathbf{r})
        \right]
} \nonumber \\[6pt]
&amp;= \langle { {\cal A}(\mathbf{p}', \mathbf{r})} \rangle_{\mathrm{NVT}}
\label{eq:real_time_nose_relation}
\end{align}\]

<p>where in the second step, we choose $g = 3N$.</p>

<p>In terms of the real variables, the EOM become<sup id="fnref:Hoover_PRA:1" role="doc-noteref"><a href="#fn:Hoover_PRA" class="footnote">4</a></sup></p>

\[\begin{align}
      \frac{\mathrm{d} \mathbf{r}'_i}{\mathrm{d} t'} &amp;= s \frac{\mathrm{d} \mathbf{r}_i}{\mathrm{d} t}
                                                      = \frac{\mathbf{p}_i}{m_i s}
                                                      = \frac{\mathbf{p}'_i}{m_i} \label{eq:real_eom_1} \\[6pt]
      \frac{\mathrm{d} \mathbf{p}'_i}{\mathrm{d} t'} &amp;= s\frac{\mathrm{d} {\mathbf{p}_i / s}}{\mathrm{d} t}
                                                      = \frac{\mathrm{d} \mathbf{p}_i}{\mathrm{d} t} - 
                                                        {1\over s} \mathbf{p}_i \frac{\mathrm{d} s}{\mathrm{d} t} \nonumber \\[6pt]
                                                     &amp;= -\frac{\partial\, V(\mathbf{r}'_1,\ldots,\mathbf{r}'_N)}{\partial\,\mathbf{r}'_i} -
                                                        ({s'} p'_s / Q) \mathbf{p}'_i \label{eq:real_eom_2} \\[6pt]
     {1\over s'} \frac{\mathrm{d} s'}{\mathrm{d} t'} &amp;= {s\over s}\frac{\mathrm{d} s}{\mathrm{d} t} = { {s'} {p'}_s \over Q} \label{eq:real_eom_3} \\[6pt]
 \frac{\mathrm{d} ({s'} {p'}_s / Q) }{\mathrm{d} t'} &amp;= {s \over Q} \frac{\mathrm{d} p_s}{\mathrm{d} t} 
                                                      = {1\over Q}\left[\sum_i { {\mathbf{p}'}_i^2\over m_i} - g'k_B T\right] \label{eq:real_eom_4}
\end{align}\]

<p>The following quantity is a conserved in the trajectory generated by
Eq.\eqref{eq:real_eom_1} to \eqref{eq:real_eom_4}.</p>

\[\begin{equation}
\label{eq:real_eom_conserved}
{\cal H}'_N = \sum_{i=1}^{N} \frac{ {\mathbf{p}'}_i^2}{2m_i} + V(\mathbf{r}'_1,\ldots,\mathbf{r}'_N) + 
             \frac{ {s'}^2 {p'}_s^2}{2Q} + g'k_BT\ln{s'}
\end{equation}\]

<p>Note, however, ${\cal H}’_N$ is NOT a Hamiltonian, since the EOM
\eqref{eq:real_eom_1} to \eqref{eq:real_eom_4} can NOT be derived from it.</p>

<p>In pratical implementations, Eq.\eqref{eq:real_eom_1} to \eqref{eq:real_eom_4}
can be further simplified by introducing</p>

\[\begin{equation}
\xi' = \ln s'; \qquad p'_{\xi'} = s' p'_{s'}
\end{equation}\]

<p>which leads to EOM</p>

\[\begin{align}
      \frac{\mathrm{d} \mathbf{r}'_i}{\mathrm{d} t'} &amp;= \frac{\mathbf{p}'_i}{m_i} \label{eq:prac_eom_1} \\[6pt]
      \frac{\mathrm{d} \mathbf{p}'_i}{\mathrm{d} t'} &amp;= -\frac{\partial\, V(\mathbf{r}'_1,\ldots,\mathbf{r}'_N)}{\partial\,\mathbf{r}'_i} -
                                                         {p'_{\xi'} \over Q} \mathbf{p}'_i \label{eq:prac_eom_2} \\[6pt]
               \frac{\mathrm{d} \xi'}{\mathrm{d} t'} &amp;= \frac{p'_{\xi'}}{Q} \label{eq:prac_eom_3} \\[6pt]
         \frac{\mathrm{d} p'_{\xi'} }{\mathrm{d} t'} &amp;= \sum_i { {\mathbf{p}'}_i^2\over m_i} - g'k_B T \label{eq:prac_eom_4} \\[6pt]
\end{align}\]

<p>As can be seen in the derivation of Eq.\eqref{eq:real_time_nose_relation}, $g’$
in Eq.\eqref{eq:real_eom_4}, \eqref{eq:real_eom_conserved} and
\eqref{eq:prac_eom_4} equals $3N$.</p>

<p>A few remarks on the “thermal inertia” $Q$:</p>

<ul>
  <li>
    <p>In principal, <em>any finite (positive)</em> $Q$ is guaranteed to generate a
canonical ensemble. In practice, $Q$ must be chosen carefully.</p>
  </li>
  <li>
    <p>$Q$ too large lead to poor temperature control, the canonical ensemble can
only be obtained after very long simulation. In the limit $Q \to \infty$,
reduces to NVE ensemble.</p>
  </li>
  <li>
    <p>Too small value of $Q$ will result in high-frequency temperature oscillation,
which might be off-resonance with the characteristic vibrational frequencies
(phonon frequencies) of the real system  and effectively decouple from the
real system. It also means a more pronounced interference with the natural
dynamics of the particles.</p>
  </li>
  <li>
    <p>Therefore, when aiming at a precise measurement of dynamical properties, such
as diffusion or vibrations, you should use a larger value of $Q$ or consider
running the simulation in the NVE ensemble to avoid artifacts of the
thermostat.</p>
  </li>
  <li>
    <p>Nosé in his paper<sup id="fnref:Nose_JCP:3" role="doc-noteref"><a href="#fn:Nose_JCP" class="footnote">3</a></sup> suggested to choose $Q$ as</p>

\[\begin{equation}
\label{eq:suggestedQ}
Q = \frac{2gk_BT}{\omega_0^2}
\end{equation}\]

    <p>where $\omega_0$ is the characteristic phonon frequency of the system.</p>

    <p>If the $Q$ is chosen appropriately, then the relative variance of the
temperature fluctuation should be given by Eq. \eqref{eq:temperature_var}.</p>
  </li>
  <li>
    <p>In <code class="language-plaintext highlighter-rouge">VASP</code>, $Q$ is specified by the <code class="language-plaintext highlighter-rouge">SMASS</code> tag, in unit of $[\mathtt{Atomic
Mass} \times \mathtt{a}^2]$, where $\mathtt{a}$ is the length of the first
basis vector. See the comments in <code class="language-plaintext highlighter-rouge">stepver.F</code>, i.e.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>!  SMASS    mass Parameter for nose dynamic, it has the dimension
!           of a Energy*time**2 = mass*length**2 and is supplied in
!           atomic mass * ULX**2 (this makes it  easy to define
!           the parameter)
!         &lt;0     microcanonical ensemble
!                if ISCALE is 1 scale velocities to TS
!         -2     dont change velocities at all
</pre></td></tr></tbody></table></code></div>    </div>

    <p>If you set <code class="language-plaintext highlighter-rouge">SMASS = 0</code> in  <code class="language-plaintext highlighter-rouge">INCAR</code>, <code class="language-plaintext highlighter-rouge">VASP</code> will calculate $Q$ so that $2\pi /
\omega_0 = 40 \times \mathtt{POTIM}$, as can be seen in <code class="language-plaintext highlighter-rouge">main.F</code>.</p>

    <div class="language-fortran highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">DYN</span><span class="o">%</span><span class="n">SMASS</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w">  </span><span class="n">DYN</span><span class="o">%</span><span class="n">SMASS</span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w">
 </span><span class="p">((</span><span class="mf">40._q</span><span class="o">*</span><span class="n">DYN</span><span class="o">%</span><span class="n">POTIM</span><span class="o">*</span><span class="mf">1E-15_q</span><span class="p">/</span><span class="mf">2._q</span><span class="p">/</span><span class="n">PI</span><span class="p">/</span><span class="n">LATT_CUR</span><span class="o">%</span><span class="n">ANORM</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="w"> </span><span class="p">&amp;</span><span class="w">
 </span><span class="mf">2.E20_q</span><span class="o">*</span><span class="n">BOLKEV</span><span class="o">*</span><span class="n">EVTOJ</span><span class="p">/</span><span class="n">AMTOKG</span><span class="o">*</span><span class="n">NDEGREES_OF_FREEDOM</span><span class="o">*</span><span class="nb">MAX</span><span class="p">(</span><span class="n">DYN</span><span class="o">%</span><span class="n">TEBEG</span><span class="p">,</span><span class="n">DYN</span><span class="o">%</span><span class="n">TEEND</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></div>    </div>

    <p>One can use this <a href="https://github.com/QijingZheng/pyband/blob/master/nose_mass.py" target="_blank">helping script</a> to estimate the Nosé mass for <code class="language-plaintext highlighter-rouge">VASP</code>
calculation. For example:</p>

    <div class="language-terminal highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="gp">$</span><span class="w"> </span>./nose_mass.py <span class="nt">-h</span>
<span class="go">
usage: nose_mass.py [-h] [-i POSCAR] [-u {cm-1,fs}] [-T TEMPERATURE] [-f FREQUENCY]

optional arguments:
  -h, --help            show this help message and exit
  -i POSCAR             Real POSCAR to calculate the No. of Degrees of freedom
  -u {cm-1,fs}          Default unit of input frequency
  -T TEMPERATURE, --temperature TEMPERATURE
            The temperature.
  -f FREQUENCY, --frequency FREQUENCY
            The frequency of the temperature oscillation

</span><span class="gp">$</span><span class="w"> </span>./nose_mass.py <span class="nt">-T</span> 100 <span class="nt">-f</span> 400 <span class="nt">-u</span> cm-1
<span class="go">
SMASS = 0.0038811353623434955
</span></pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ul>

<h4 id="pros--cons">Pros &amp; Cons</h4>

<ul>
  <li>
    <p>Non-ergodic for 1D harmonic oscillator.</p>

    <details>
      <summary>CLICK TO SHOW THE CODE!</summary>
      <div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="rouge-code"><pre>  <span class="c1">#!/usr/bin/env python
</span>  <span class="c1"># -*- coding: utf-8 -*-
</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>


  <span class="k">def</span> <span class="nf">harmonic_pot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
      <span class="s">'''
      The harmonic potential
      '''</span>

      <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>

  <span class="k">def</span> <span class="nf">harmonic_for</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
      <span class="s">'''
      The force of harmonic potential
      '''</span>

      <span class="k">return</span> <span class="o">-</span> <span class="n">m</span> <span class="o">*</span> <span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span>

  <span class="k">def</span> <span class="nf">Ekin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
      <span class="s">'''
      The force of harmonic potential
      '''</span>

      <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span>

  <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
      <span class="s">'''
      '''</span>

      <span class="k">print</span><span class="p">(</span><span class="s">"{:20.8E} {:20.8E} {:20.8E} {:20.8E} {:20.8E}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
          <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span>
          <span class="n">Ekin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> 
          <span class="n">harmonic_pot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">),</span>
          <span class="n">harmonic_pot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ekin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
      <span class="p">))</span>



  <span class="k">def</span> <span class="nf">nose_hoover</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">f0</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
      <span class="s">'''
      Velocity Verlet integration for Langevin thermostat
      '''</span>

      <span class="k">if</span> <span class="n">f0</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">f0</span> <span class="o">=</span> <span class="n">harmonic_for</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>

      <span class="n">log</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>

      <span class="n">eta0</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="c1"># 0, 1, 2 represents t, t + 0.5*dt, and t + dt, respectively
</span>      <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span><span class="p">):</span>
          <span class="n">x2</span>   <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">v0</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f0</span> <span class="o">/</span> <span class="n">m</span> <span class="o">-</span> <span class="n">eta0</span> <span class="o">*</span> <span class="n">v0</span><span class="p">)</span>
          <span class="n">v1</span>   <span class="o">=</span> <span class="n">v0</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">f0</span> <span class="o">/</span> <span class="n">m</span> <span class="o">-</span> <span class="n">eta0</span> <span class="o">*</span> <span class="n">v0</span><span class="p">)</span>
          <span class="n">f2</span>   <span class="o">=</span> <span class="n">harmonic_for</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
          <span class="n">eta1</span> <span class="o">=</span> <span class="n">eta0</span> <span class="o">+</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">Q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">v0</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span>
          <span class="n">eta2</span> <span class="o">=</span> <span class="n">eta1</span> <span class="o">+</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">Q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">v1</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span>
          <span class="n">v2</span>   <span class="o">=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">f2</span> <span class="o">/</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">eta2</span><span class="p">)</span>

          <span class="n">log</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
          <span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">f0</span> <span class="o">=</span> <span class="n">x2</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">f2</span>


  <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
      <span class="n">T0</span> <span class="o">=</span> <span class="mf">0.1</span>
      <span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">T0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
      <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span>
      <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>
      <span class="n">N</span>  <span class="o">=</span> <span class="mi">20000</span>

      <span class="n">nose_hoover</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div>      </div>
    </details>

    <figure>
  <div align="center">
      <a href="/assets/img/post/nvt_md/nose-hoover/NoseHoover_1DHO.png" data-lightbox="roadtrip">
          <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/nvt_md/nose-hoover/NoseHoover_1DHO.png" width="75%" />
      </a>
  </div>
  
  <figcaption style="text-align: center; padding: 10px">
    <b> Figure 3. </b>
    Phase space distribution of 1D harmonic oscillator obtained from MD
    simulation with the Nosé-Hoover thermostat.  The integration scheme in
    this
    <a target="_blank" href="https://QijingZheng.github.io/assets/img/post/nvt_md/nose-hoover/MVP03.pdf">reference</a>
    was used.
    The Nosé-Hoover does NOT yield canonical distribution in phase space.

    Figure plotted using
    <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/nose-hoover/plt_nosehoover_xp.py">this script</a>
    with 
    <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/nose-hoover/nosehoover_xp.dat">this input data.</a>
  </figcaption>
</figure>
  </li>
</ul>

<h3 id="nosé-hoover-chains">Nosé-Hoover Chains</h3>

<p>The non-ergodic problem can be solved by Nosé-Hoover chain method proposed by
Martyna and Tuckerman et al.<sup id="fnref:Tuckerman_2000" role="doc-noteref"><a href="#fn:Tuckerman_2000" class="footnote">6</a></sup><sup id="fnref:Martyna_1992" role="doc-noteref"><a href="#fn:Martyna_1992" class="footnote">7</a></sup> The EOM in real
variables (for simplicity, we omit the primes)<sup id="fnref:FrenkelSmit:3" role="doc-noteref"><a href="#fn:FrenkelSmit" class="footnote">1</a></sup><sup id="fnref:Martyna_1996" role="doc-noteref"><a href="#fn:Martyna_1996" class="footnote">8</a></sup></p>

\[\begin{align}
      \frac{\mathrm{d}\, \mathbf{r}_i}{\mathrm{d}\, t} &amp;= \frac{\mathbf{p}_i}{m_i} \label{eq:nhv_eom_1} \\[6pt]
      \frac{\mathrm{d}\, \mathbf{p}_i}{\mathrm{d}\, t} &amp;= -\frac{\partial\, V(\mathbf{r}_1,\ldots,\mathbf{r}_N)}{\partial\,\mathbf{r}_i} -
                                                       {p_{\xi_1} \over Q_1} \mathbf{p}_i \label{eq:nhv_eom_2} \\[6pt]
             \frac{\mathrm{d}\, \xi_k}{\mathrm{d}\, t} &amp;= \frac{p_{\xi_k}}{Q_k}\qquad k = 1 ,\ldots, M \label{eq:nhv_eom_3} \\[6pt]
        \frac{\mathrm{d}\, p_{\xi_1} }{\mathrm{d}\, t} &amp;= \left[
                                                          \sum_i { {\mathbf{p}}_i^2\over m_i} - gk_B T
                                                      \right] - 
                                                       {p_{\xi_2} \over Q_2} p_{\xi_1}
                                                      \label{eq:nhv_eom_4} \\[6pt]
        \frac{\mathrm{d}\, p_{\xi_k} }{\mathrm{d}\, t} &amp;= \left[
                                                          {p^2_{\xi_{k-1}} \over Q_{k-1}} - k_BT
                                                      \right] - 
                                                       {p_{\xi_{k+1}} \over Q_{k+1}} p_{\xi_k}
                                                      \label{eq:nhv_eom_5} \\[6pt]
        \frac{\mathrm{d}\, p_{\xi_M} }{\mathrm{d}\, t} &amp;= \left[
                                                          {p^2_{\xi_{M-1}} \over Q_{M-1}} - k_BT
                                                      \right]  
                                                      \label{eq:nhv_eom_6} \\[6pt]
\end{align}\]

<p>where $M$ is the chain length and $g = 3N$. For these EOM, the conserved
quantity is</p>

\[\begin{equation}
{\cal H}_{\mathrm{NHC}} = \sum_{i=1}^{N} \frac{ {\mathbf{p}}_i^2}{2m_i} + V(\mathbf{r}_1,\ldots,\mathbf{r}_N)
                        + \sum_{k=1}^M {p_{\xi_k}^2 \over 2Q_k} + gk_BT\xi_1
                        + \sum_{k=2}^M k_BT\xi_k
\end{equation}\]

<p>Martyna<sup id="fnref:Martyna_1996:1" role="doc-noteref"><a href="#fn:Martyna_1996" class="footnote">8</a></sup> suggest to choose the “thermal inertia” by <sup id="fnref:qz_note_1" role="doc-noteref"><a href="#fn:qz_note_1" class="footnote">9</a></sup></p>

\[\begin{align}
Q_1 &amp;= {Nk_BT \over \omega_0^2} &amp; \\[6pt]
Q_k &amp;= {k_BT \over \omega_0^2}    &amp; \quad 1 &lt; k \le M 
\end{align}\]

<h4 id="code-implementation">Code Implementation</h4>

<p>Below is the code that implement the Nosé-Hoover chain method to simulate the
NVT ensemble for 1D harmonic oscillator, where an explicit time-reversible
integrator is used. <sup id="fnref:Martyna_1996:2" role="doc-noteref"><a href="#fn:Martyna_1996" class="footnote">8</a></sup><sup id="fnref:jax_md" role="doc-noteref"><a href="#fn:jax_md" class="footnote">10</a></sup><sup id="fnref:openmmtools" role="doc-noteref"><a href="#fn:openmmtools" class="footnote">11</a></sup></p>

<details>
  <summary>CLICK TO SHOW THE CODE!</summary>
  <div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python
# -*- coding: utf-8 -*-
</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>


<span class="k">def</span> <span class="nf">harmonic_pot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s">'''
    The harmonic potential
    '''</span>

    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">harmonic_for</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s">'''
    The force of harmonic potential
    '''</span>

    <span class="k">return</span> <span class="o">-</span> <span class="n">m</span> <span class="o">*</span> <span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">Ekin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s">'''
    The force of harmonic potential
    '''</span>

    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span>

<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s">'''
    '''</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"{:20.8E} {:20.8E} {:20.8E} {:20.8E} {:20.8E}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span>
        <span class="n">Ekin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> 
        <span class="n">harmonic_pot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">),</span>
        <span class="n">harmonic_pot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span> <span class="o">+</span> <span class="n">Ekin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="p">))</span>


<span class="k">def</span> <span class="nf">nose_hoover_chain</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nys</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">f0</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="s">'''
    G. J. Martyna, M. E. Tuckerman, D. J. Tobias, and Michael L. Klein,
    "Explicit reversible integrators for extended systems dynamics"
    Molecular Physics, 87, 1117-1157 (1996) 
    '''</span>

    <span class="k">assert</span> <span class="n">M</span> <span class="o">&gt;=</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">nc</span> <span class="o">&gt;=</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">nys</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">nys</span> <span class="o">==</span> <span class="mi">5</span>

    <span class="k">if</span> <span class="n">nys</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">wdti</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">])</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">nc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="mi">4</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">wdti</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">])</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">nc</span>

    <span class="n">Qmass</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="o">*</span> <span class="n">Q1</span>
    <span class="c1"># if M &gt; 1: Qmass[1:] /= 2
</span>    <span class="n">Vlogs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">Xlogs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">Glogs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="c1"># for ii in range(1, M):
</span>    <span class="c1">#     Glogs[ii] = (Qmass[ii-1] * Vlogs[ii-1]**2 - T) / Qmass[ii]
</span>
    <span class="k">if</span> <span class="n">f0</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">harmonic_for</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>

    <span class="n">log</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">nhc_step</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Glogs</span><span class="p">,</span> <span class="n">Vlogs</span><span class="p">,</span> <span class="n">Xlogs</span><span class="p">):</span>
        <span class="s">'''
        '''</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">M</span>     <span class="o">=</span> <span class="n">Glogs</span><span class="p">.</span><span class="n">size</span>
        <span class="n">K</span>     <span class="o">=</span> <span class="n">Ekin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="n">K2</span>    <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">K</span>
        <span class="n">Glogs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">K2</span> <span class="o">-</span> <span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="n">Qmass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">inc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iys</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nys</span><span class="p">):</span>
                <span class="n">wdt</span> <span class="o">=</span> <span class="n">wdti</span><span class="p">[</span><span class="n">iys</span><span class="p">]</span>
                <span class="c1"># update the thermostat velocities
</span>                <span class="n">Vlogs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">Glogs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">wdt</span>

                <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">AA</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.125</span> <span class="o">*</span> <span class="n">wdt</span> <span class="o">*</span> <span class="n">Vlogs</span><span class="p">[</span><span class="n">M</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">kk</span><span class="p">])</span>
                    <span class="n">Vlogs</span><span class="p">[</span><span class="n">M</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vlogs</span><span class="p">[</span><span class="n">M</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">kk</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA</span> <span class="o">*</span> <span class="n">AA</span> \
                                  <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">wdt</span> <span class="o">*</span> <span class="n">Glogs</span><span class="p">[</span><span class="n">M</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">kk</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA</span>

                <span class="c1"># update the particle velocities
</span>                <span class="n">AA</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">wdt</span> <span class="o">*</span> <span class="n">Vlogs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">scale</span> <span class="o">*=</span> <span class="n">AA</span>
                <span class="c1"># update the forces
</span>                <span class="n">Glogs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">K2</span> <span class="o">-</span> <span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="n">Qmass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># update the thermostat positions
</span>                <span class="n">Xlogs</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Vlogs</span> <span class="o">*</span> <span class="n">wdt</span>
                <span class="c1"># update the thermostat velocities
</span>                <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">AA</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.125</span> <span class="o">*</span> <span class="n">wdt</span> <span class="o">*</span> <span class="n">Vlogs</span><span class="p">[</span><span class="n">kk</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">Vlogs</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vlogs</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA</span> <span class="o">*</span> <span class="n">AA</span> \
                              <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">wdt</span> <span class="o">*</span> <span class="n">Glogs</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">*</span> <span class="n">AA</span>
                    <span class="n">Glogs</span><span class="p">[</span><span class="n">kk</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Qmass</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">*</span> <span class="n">Vlogs</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="n">Qmass</span><span class="p">[</span><span class="n">kk</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Vlogs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">Glogs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">wdt</span>

        <span class="k">return</span> <span class="n">v</span> <span class="o">*</span> <span class="n">scale</span>

    <span class="c1"># 0, 1, 2 represents t, t + 0.5*dt, and t + dt, respectively
</span>    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsteps</span><span class="p">):</span>
        <span class="n">vnhc</span> <span class="o">=</span> <span class="n">nhc_step</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">Glogs</span><span class="p">,</span> <span class="n">Vlogs</span><span class="p">,</span> <span class="n">Xlogs</span><span class="p">)</span>
        <span class="n">v1</span>   <span class="o">=</span> <span class="n">vnhc</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="n">m</span>
        <span class="n">x2</span>   <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">f2</span>   <span class="o">=</span> <span class="n">harmonic_for</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
        <span class="n">v2p</span>  <span class="o">=</span> <span class="n">v1</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">f2</span> <span class="o">/</span> <span class="n">m</span>
        <span class="n">v2</span>   <span class="o">=</span> <span class="n">nhc_step</span><span class="p">(</span><span class="n">v2p</span><span class="p">,</span> <span class="n">Glogs</span><span class="p">,</span> <span class="n">Vlogs</span><span class="p">,</span> <span class="n">Xlogs</span><span class="p">)</span>

        <span class="n">log</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">f0</span> <span class="o">=</span> <span class="n">x2</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">f2</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">T0</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">T0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">N</span>  <span class="o">=</span> <span class="mi">20000</span>

    <span class="n">nose_hoover_chain</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">Q1</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div>  </div>
</details>

<ul>
  <li>
    <p>Different chain lengths $M$</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="n">T0</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">T0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">N</span>  <span class="o">=</span> <span class="mi">20000</span>
  
<span class="n">nose_hoover_chain</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">Q1</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
<span class="n">nose_hoover_chain</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">Q1</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div>    </div>

    <figure>
  <div align="center">
      <a href="/assets/img/post/nvt_md/nose-hoover/xp_nhc_len.png" data-lightbox="roadtrip">
          <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/nvt_md/nose-hoover/xp_nhc_len.png" width="98%" />
      </a>
  </div>
  
  <figcaption style="text-align: center; padding: 10px">
    <b> Figure 4. </b>
    Phase space distribution of 1D harmonic oscillator obtained from NVT MD
    simulation with the Nosé-Hoover chain method. Left: NHC method with chain
    length $M = 1$; Right: NHC method with chain length $M = 2$. An
    <a href="https://www.tandfonline.com/doi/abs/10.1080/00268979600100761" target="_blank">explicit time-reversible integrator</a>
    was used.

    Figure plotted using
    <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/nose-hoover/plt_nhc_xp.py">this script</a>
    with 
    <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/nose-hoover/nhc-m_xp.tgz">this input data.</a>
  </figcaption>
</figure>

    <figure>
  <div align="center">
      <a href="/assets/img/post/nvt_md/nose-hoover/temp_fluc_nhc2.png" data-lightbox="roadtrip">
          <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/nvt_md/nose-hoover/temp_fluc_nhc2.png" width="100%" />
      </a>
  </div>
  
  <figcaption style="text-align: center; padding: 10px">
    <b> Figure 5. </b>
    Temperature fluctuation of 1D harmonic oscillator obtained from NVT MD
    simulation with the Nosé-Hoover chain method (chain length: $M=2$). The
    black solid line is the instantaneous temperature and the red line is the
    averaged temperature. The blue horizontal line shows the target
    temperature.

    Figure plotted using
    <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/nose-hoover/plt_temp_nhc2.py">this script</a>
    with 
    <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/nose-hoover/nhc-2_xp.dat">this input data.</a>
  </figcaption>
</figure>
  </li>
  <li>
    <p>Different initial condictions for $M = 1$</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">T0</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">N</span>  <span class="o">=</span> <span class="mi">20000</span>
  
<span class="k">for</span> <span class="n">x0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">np</span><span class="p">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">].</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)).</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">T0</span><span class="p">):</span>
  <span class="n">nose_hoover_chain</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">Q1</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div>    </div>

    <figure>
  <div align="center">
      <a href="/assets/img/post/nvt_md/nose-hoover/xp_nhc1_init.png" data-lightbox="roadtrip">
          <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/nvt_md/nose-hoover/xp_nhc1_init.png" width="100%" />
      </a>
  </div>
  
  <figcaption style="text-align: center; padding: 10px">
    <b> Figure 6. </b>
    The phase space distribution of 1D harmonic oscillator from Nose-Hoover
    thermostat ($M = 1$) depends on the initial conditions.

    Figure plotted using
    <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/nose-hoover/plt_nhc1_init.py">this script</a>
    with 
    <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/nose-hoover/nhc-1_init.npy">this input data.</a>
  </figcaption>
</figure>
  </li>
  <li>
    <p>Different thermal inertia $Q_1$</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">T0</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">T0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">N</span>  <span class="o">=</span> <span class="mi">20000</span>

<span class="n">nose_hoover_chain</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">Q1</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
<span class="n">nose_hoover_chain</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">Q1</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
<span class="n">nose_hoover_chain</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">Q1</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">/</span> <span class="mi">16</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div>    </div>

    <figure>
  <div align="center">
  <a href="/assets/img/post/nvt_md/nose-hoover/xp_nhc2_qmass.png" data-lightbox="roadtrip">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/nvt_md/nose-hoover/xp_nhc2_qmass.png" width="100%" />
  </a>
  </div>
  
  <figcaption style="text-align: center; padding: 10px">
    <b> Figure 7. </b>
    The phase space distribution of 1D harmonic oscillator from Nose-Hoover
    chain thermostat ($M = 2$) with different "thermal inertia" $Q_1$.

    Figure plotted using
    <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/nose-hoover/plt_nhc2_qmass.py">this script</a>
    with 
    <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/nose-hoover/nhc2_qmass.npy">this input data.</a>
  </figcaption>
</figure>

    <figure>
  <div align="center">
      <a href="/assets/img/post/nvt_md/nose-hoover/kv_qmass.png" data-lightbox="roadtrip">
          <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/nvt_md/nose-hoover/kv_qmass.png" width="100%" />
      </a>
  </div>
  
  <figcaption style="text-align: center; padding: 10px">
    <b> Figure 8. </b>
    Potential energy and kinetic energy 
    of 1D harmonic oscillator from Nose-Hoover
    chain thermostat ($M = 2$) with different "thermal inertia" $Q_1$.

    Figure plotted using
    <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/nose-hoover/plt_energy_qmass.py">this script</a>
    with 
    <a href="https://QijingZheng.github.io/assets/img/post/nvt_md/nose-hoover/nhc2_qmass.npy">this input data.</a>
  </figcaption>
</figure>
  </li>
</ul>

<h2 id="references">References</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:FrenkelSmit" role="doc-endnote">
      <p>Daan Frenkel and Berend Smit, <em>Understanding Molecular Simulation: From Algorithms to Applications</em> <a href="#fnref:FrenkelSmit" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:FrenkelSmit:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a> <a href="#fnref:FrenkelSmit:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a> <a href="#fnref:FrenkelSmit:3" class="reversefootnote" role="doc-backlink">&#8617;<sup>4</sup></a></p>
    </li>
    <li id="fn:CameronAbrams" role="doc-endnote">
      <p>Cameron Abrams, Drexel University, <a href="http://www.pages.drexel.edu/~cfa22/msim/msim.html" target="_blank">Molecular Simulations</a> <a href="#fnref:CameronAbrams" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:Nose_JCP" role="doc-endnote">
      <p><a href="https://doi.org/10.1063/1.447334" target="_blank">Shuichi Nosé, <i>J. Chem. Phys.</i>, <b>81</b>, 511(1984).</a> <a href="#fnref:Nose_JCP" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:Nose_JCP:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a> <a href="#fnref:Nose_JCP:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a> <a href="#fnref:Nose_JCP:3" class="reversefootnote" role="doc-backlink">&#8617;<sup>4</sup></a></p>
    </li>
    <li id="fn:Hoover_PRA" role="doc-endnote">
      <p><a href="https://journals.aps.org/pra/abstract/10.1103/PhysRevA.31.1695" target="_blank">William G. Hoover, <i>Phys. Rev. A</i>, <b>31</b>, 1695(1985).</a> <a href="#fnref:Hoover_PRA" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:Hoover_PRA:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:Tuckerman" role="doc-endnote">
      <p>Mark E. Tuckerman, <em>Statistical Mechanics: Theory and Molecular Simulation</em> <a href="#fnref:Tuckerman" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:Tuckerman_2000" role="doc-endnote">
      <p>Mark E. Tuckerman and Glenn J. Martyna, <a href="https://pubs.acs.org/doi/abs/10.1021/jp992433y" target="_blank">Understanding Modern Molecular Dynamics:  Techniques and Applications</a>, <i>J. Phys. Chem. B</i>, <b>104</b>, 159–178(2000) <a href="#fnref:Tuckerman_2000" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:Martyna_1992" role="doc-endnote">
      <p>Glenn J. Martyna and Michael L. Klein, <a href="https://aip.scitation.org/doi/10.1063/1.463940" target="_blank">Nosé–Hoover chains: The canonical ensemble via continuous dynamics</a>, <i>J. Chem. Phys.</i>, <b>97</b>, 2635(1992) <a href="#fnref:Martyna_1992" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:Martyna_1996" role="doc-endnote">
      <p>G. J. Martyna, M. E. Tuckerman, D. J. Tobias, and Michael L. Klein, <a href="https://www.tandfonline.com/doi/abs/10.1080/00268979600100761" target="_blank">Explicit reversible integrators for extended systems dynamics</a>, <i>Molecular Physics</i>, <b>87</b>, 1117-1157 (1996) <a href="#fnref:Martyna_1996" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:Martyna_1996:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a> <a href="#fnref:Martyna_1996:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a></p>
    </li>
    <li id="fn:qz_note_1" role="doc-endnote">
      <p>I am not sure why this Q is different from that in Eq.\eqref{eq:suggestedQ}. <a href="#fnref:qz_note_1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:jax_md" role="doc-endnote">
      <p><a href="https://github.com/google/jax-md/blob/master/jax_md/simulate.py" target="_blank">https://github.com/google/jax-md</a> <a href="#fnref:jax_md" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:openmmtools" role="doc-endnote">
      <p><a href="https://openmmtools.readthedocs.io/en/0.17.0/api/generated/openmmtools.integrators.NoseHooverChainVelocityVerletIntegrator.html#openmmtools.integrators.NoseHooverChainVelocityVerletIntegrator" target="_blank">openmmtools.integrators.NoseHooverChainVelocityVerletIntegrator</a> <a href="#fnref:openmmtools" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>


      </div>

      <div class="post-tail-wrapper text-muted">

        <!-- categories -->
        
        <div class="post-meta mb-3">
          <i class="far fa-folder-open fa-fw mr-1"></i>
          
            <a href='/categories/blogging/'>Blogging</a>,
            <a href='/categories/tutorial/'>Tutorial</a>
        </div>
        

        <!-- tags -->
        
        <div class="post-tags">
          <i class="fa fa-tags fa-fw mr-1"></i>
          
          <a href="/tags/moleculardynamics/"
            class="post-tag no-text-decoration" >MolecularDynamics</a>
          
          <a href="/tags/nvt/"
            class="post-tag no-text-decoration" >NVT</a>
          
          <a href="/tags/vasp/"
            class="post-tag no-text-decoration" >VASP</a>
          
          <a href="/tags/todo/"
            class="post-tag no-text-decoration" >TODO</a>
          
          </div>
        

        <div class="post-tail-bottom
          d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
          
          <div class="license-wrapper">
            This post is licensed under
            <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
            by the author.
          </div>
          

          <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=Molecular Dynamics at Constant Temperature - Qijing Zheng&url=https://qijingzheng.github.io/posts/NVT-MD/" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=Molecular Dynamics at Constant Temperature - Qijing Zheng&u=https://qijingzheng.github.io/posts/NVT-MD/" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://telegram.me/share?text=Molecular Dynamics at Constant Temperature - Qijing Zheng&url=https://qijingzheng.github.io/posts/NVT-MD/" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i class="fa-fw fas fa-link small" onclick="copyLink()"
        data-toggle="tooltip" data-placement="top" title="Copy link"></i>

  </span>
</div>


        </div><!-- .post-tail-bottom -->

      </div><!-- div.post-tail -->

    </div> <!-- .post -->


  </div> <!-- #post-wrapper -->

  

  

  <!--
  The Pannel on right side (Desktop views)
-->

<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

  <div class="access">

  














  

    <div id="access-lastmod" class="post">
      <span>Recent Update</span>
      <ul class="post-content pl-0 pb-1 ml-1 mt-2">

      
        
        
        
        <li><a href="/posts/Light-Matter-Interaction-and-Dipole-Transition-Matrix/">Light-Matter Interaction and Dipole Transition Matrix</a></li>
      
        
        
        
        <li><a href="/posts/VASP-All-Electron-WFC/">PAW All-Electron Wavefunction in VASP</a></li>
      
        
        
        
        <li><a href="/posts/Plotly-Spherical-Harmonics/">Plotly: Spherical Harmonics</a></li>
      
        
        
        
        <li><a href="/posts/Overlap-Integral-in-Momentum-Space/">Evaluating Overlap Integral in Momentum Space</a></li>
      
        
        
        
        <li><a href="/posts/FourierTransform-Radial-Function/">Fourier Transform of Radial Functions</a></li>
      

      </ul>
    </div> <!-- #access-lastmod -->

  

  















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  
    <div id="access-tags">
      <span>Trending Tags</span>
      <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

      
        
        <a class="post-tag" href="/tags/python/">Python</a>
      
        
        <a class="post-tag" href="/tags/matplotlib/">Matplotlib</a>
      
        
        <a class="post-tag" href="/tags/vasp/">VASP</a>
      
        
        <a class="post-tag" href="/tags/plotly/">Plotly</a>
      
        
        <a class="post-tag" href="/tags/sphericalharmonics/">SphericalHarmonics</a>
      
        
        <a class="post-tag" href="/tags/tikz/">TikZ</a>
      
        
        <a class="post-tag" href="/tags/phonon/">Phonon</a>
      
        
        <a class="post-tag" href="/tags/phonopy/">Phonopy</a>
      
        
        <a class="post-tag" href="/tags/plotting/">Plotting</a>
      
        
        <a class="post-tag" href="/tags/brillouinzone/">BrillouinZone</a>
      

      </div>
    </div>
  
  </div> <!-- .access -->

  
    <!-- BS-toc.js will be loaded at medium priority -->
    <!-- <script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap&#45;toc@1.0.1/dist/bootstrap&#45;toc.min.js"></script> -->
    <script src='/assets/js/dist/bootstrap-toc.js'></script>
    <div id="toc-wrapper" class="pl-0 pr-4 mb-5">
      <span class="pl-3 pt-2 mb-2">Contents</span>
      <nav id="toc" data-toggle="toc"></nav>
    </div>
  

</div> <!-- #panel-wrapper -->


</div> <!-- .row -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->






  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/Band-unfolding-tutorial/">
          <div class="card-body">
            <!--
  Date format snippet
-->





<span class="timeago small"
  >

  
  

  
    Mar 18, 2021
  

  <i class="unloaded">2021-03-18T14:56:00+08:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Band Unfolding Tutorial</h3>
            <div class="text-muted small">
              <p>
                





                Introduction

The supercell (SC) method is the ubiquitous approach for the study of
solid-state periodic boundary condition systems. In the simplest case, one just
construct an SC by repeating the ...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/VASP-stacking-dependent-energy-of-MoS2-bilayer/">
          <div class="card-body">
            <!--
  Date format snippet
-->





<span class="timeago small"
  >

  
  

  
    Mar 31, 2021
  

  <i class="unloaded">2021-03-31T08:40:00+08:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>VASP: Stacking-dependent Potential Energy Surface of Bilayer MoS<sub>2</sub></h3>
            <div class="text-muted small">
              <p>
                





                Introduction

A few days ago, I met a problem so that I needed to calculate the
stacking-dependent energy of bilayer MoS2.  As is shown in the figure
below, by shifting one of the two layers relati...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/VASP-All-Electron-WFC/">
          <div class="card-body">
            <!--
  Date format snippet
-->





<span class="timeago small"
  >

  
  

  
    Oct  2
  

  <i class="unloaded">2022-10-02T21:34:00+08:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>PAW All-Electron Wavefunction in VASP</h3>
            <div class="text-muted small">
              <p>
                





                {% assign figCounter = 0 %}

Introduction

In the PAW method, the all-electron (AE) wavefunction (AEWFC)
$\psi_{n\mathbf{k}}$ is related to the pseudo-wavefucntion (PSWFC)
$\tilde\psi_{n\mathbf{k}}...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->



    <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/Numerov-Algorithm/" class="btn btn-outline-primary"
    prompt="Older">
    <p>Numerov Algorithm</p>
  </a>
  

  
  <a href="/posts/FourierTransform-Radial-Function/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>Fourier Transform of Radial Functions</p>
  </a>
  

</div>


    

    </div> <!-- #post-extend-wrapper -->

  </div> <!-- .col-* -->

</div> <!-- .row -->



  <!--
  image lazy load: https://github.com/ApoorvSaxena/lozad.js
-->
<!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> -->
<script type="text/javascript" src='/assets/js/dist/lozad.min.js'></script>

<script type="text/javascript">
  const imgs = document.querySelectorAll('.post-content img');
  const observer = lozad(imgs);
  observer.observe();
</script>




        <!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center">
    <div class="footer-left">
      <p class="mb-0">
        © 2022
        <a href="https://github.com/QijingZheng">Qijing Zheng</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        Powered by
        <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
        with
        <a href="https://github.com/cotes2020/jekyll-theme-chirpy"
          target="_blank" rel="noopener">Chirpy</a>
        theme.
      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      <h4 class="text-muted mb-4">Trending Tags</h4>

      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



      
        
        <a class="post-tag" href="/tags/python/">Python</a>
      
        
        <a class="post-tag" href="/tags/matplotlib/">Matplotlib</a>
      
        
        <a class="post-tag" href="/tags/vasp/">VASP</a>
      
        
        <a class="post-tag" href="/tags/plotly/">Plotly</a>
      
        
        <a class="post-tag" href="/tags/sphericalharmonics/">SphericalHarmonics</a>
      
        
        <a class="post-tag" href="/tags/tikz/">TikZ</a>
      
        
        <a class="post-tag" href="/tags/phonon/">Phonon</a>
      
        
        <a class="post-tag" href="/tags/phonopy/">Phonopy</a>
      
        
        <a class="post-tag" href="/tags/plotting/">Plotting</a>
      
        
        <a class="post-tag" href="/tags/brillouinzone/">BrillouinZone</a>
      

    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<!-- <script src="https://cdn.jsdelivr.net/npm/simple&#45;jekyll&#45;search@1.7.3/dest/simple&#45;jekyll&#45;search.min.js"></script> -->
<script src='/assets/js/dist/simple-jekyll-search.min.js'></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="https://QijingZheng.github.io{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


  </body>

</html>

